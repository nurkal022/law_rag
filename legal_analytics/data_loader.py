"""
Загрузчик данных для правовой аналитики
"""

import pandas as pd
import json
from typing import List, Dict, Any, Optional
from datetime import datetime
import os


class DataLoader:
    """Загрузчик данных для анализа комментариев к законопроектам"""
    
    def __init__(self):
        self.demo_data = self._get_demo_data()
    
    def load_from_excel(self, file_path: str) -> List[Dict[str, Any]]:
        """Загрузка данных из Excel файла"""
        try:
            # Читаем Excel файл
            df = pd.read_excel(file_path)
            
            # Преобразуем в нужный формат
            projects = []
            for _, row in df.iterrows():
                project = {
                    'id': str(row.get('id', '')),
                    'title': str(row.get('title', '')),
                    'url': str(row.get('url', '')),
                    'category': str(row.get('category', '')),
                    'status': str(row.get('status', '')),
                    'comments': self._parse_comments(row.get('comments', '')),
                    'total_comments': len(self._parse_comments(row.get('comments', '')))
                }
                projects.append(project)
            
            return projects
            
        except Exception as e:
            print(f"Ошибка загрузки Excel файла: {e}")
            return []
    
    def load_demo_data(self) -> List[Dict[str, Any]]:
        """Загрузка демо-данных"""
        return self.demo_data
    
    def _parse_comments(self, comments_str: str) -> List[Dict[str, Any]]:
        """Парсинг комментариев из строки"""
        if not comments_str or pd.isna(comments_str):
            return []
        
        try:
            # Пытаемся парсить как JSON
            if isinstance(comments_str, str) and comments_str.strip().startswith('['):
                return json.loads(comments_str)
            
            # Простой парсинг через разделители
            comments = []
            lines = str(comments_str).split('\n')
            
            current_comment = {}
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                # Определяем автора (обычно в верхнем регистре)
                if line.isupper() and len(line) > 3:
                    if current_comment:
                        comments.append(current_comment)
                    current_comment = {'author': line, 'content': '', 'timestamp': ''}
                elif current_comment:
                    if not current_comment['content']:
                        current_comment['content'] = line
                    else:
                        current_comment['content'] += ' ' + line
            
            if current_comment:
                comments.append(current_comment)
            
            return comments
            
        except Exception as e:
            print(f"Ошибка парсинга комментариев: {e}")
            return []
    
    def _get_demo_data(self) -> List[Dict[str, Any]]:
        """Демо-данные для тестирования"""
        return [
            {
                "id": "15567336",
                "title": "О внесении изменения в приказ Министра национальной экономики Республики Казахстан от 20 ноября 2014 года № 98 «Об утверждении Правил ведения реестра государственных услуг»",
                "url": "https://legalacts.egov.kz/npa/view?id=15567336",
                "category": "Информационные технологии",
                "status": "На рассмотрении",
                "comments": [
                    {
                        "author": "АНАСТАСИЯДИ МИХАИЛ",
                        "content": "Согласно третьего абзаца пункта 4 статьи 18 Закона Республики Казахстан «О правовых актах» разработанные проекты подзаконных нормативных правовых актов вместе с пояснительными записками и сравнительными таблицами к ним (в случаях внесения изменений и (или) дополнений в подзаконные нормативные правовые акты), за исключением проектов нормативных правовых актов Президента Республики Казахстан, разработанных Канцелярией Первого Президента Республики Казахстан - Елбасы, Администрацией Президента Республики Казахстан, направляются на согласование в заинтересованные государственные органы и размещаются для публичного обсуждения на интернет-портале открытых нормативных правовых актов. Прошу привести в соответствие.",
                        "timestamp": "04/08 - 18:24",
                        "date": "04/08",
                        "time": "18:24",
                        "comment_id": "АНАСТАСИЯДИ МИХАИЛ_Согласно третьего абзаца пункта 4 статьи 18 Закона_04/08 - 18:24"
                    },
                    {
                        "author": "СУХАНОВ АНДРЕЙ",
                        "content": "Не вводите пользователей Портала в заблуждение. Абсолютно никакого удобства для населения (пользователей Портала) и никакой доступной для ознакомления формы эта так называемая «оптимизации процесса публичного обсуждения проектов НПА» не принесла. Как-раз-таки наоборот! Просто было некое неправомерное поручение Министерства юстиции РК (ДСП), согласно которому само Министерство НЕЗАКОННО изменило перечень подлежащих публичному обсуждению проектов подзаконных НПА, состав прилагаемых документов и формат размещения проектов подзаконных НПА на Портале с начала апреля текущего года, продолжает игнорировать законодательно установленные требования пункта 4 статьи 18 Закона РК «О правовых актах» и приказа и.о. Министра юстиции РК от 30 сентября 2021 года № 849 «Об утверждении Правил размещения и публичного обсуждения проектов подзаконных нормативных правовых актов на интернет-портале открытых нормативных правовых актов» и понуждает к подобным нарушениям иных органов-разработчиков проектов НПА. Без внесения соответствующих изменений в действующее законодательство это полное самоуправство и правовой беспредел со стороны МЮ РК, которые безоговорочно приняли и вынужденно продолжают поддерживать практически все органы-разработчики проектов подзаконных НПА!!!",
                        "timestamp": "04/08 - 09:09",
                        "date": "04/08",
                        "time": "09:09",
                        "comment_id": "СУХАНОВ АНДРЕЙ_Не вводите пользователей Портала в заблуждение_04/08 - 09:09"
                    },
                    {
                        "author": "СУХАНОВ АНДРЕЙ",
                        "content": "Ввиду отсутствия самого проекта НПА, Пояснительной записки и Сравнительной таблицы на Портале, как этого требует действующее законодательство, его публичное обсуждение не может считаться состоявшимся!",
                        "timestamp": "01/08 - 14:17",
                        "date": "01/08",
                        "time": "14:17",
                        "comment_id": "СУХАНОВ АНДРЕЙ_Ввиду отсутствия самого проекта НПА_01/08 - 14:17"
                    },
                    {
                        "author": "МИНИСТЕРСТВО ЦИФРОВОГО РАЗВИТИЯ, ИННОВАЦИЙ И АЭРОКОСМИЧЕСКОЙ ПРОМЫШЛЕННОСТИ РК",
                        "content": "Здравствуйте! Согласно последним техническим доработкам Портала, в целях оптимизации процесса публичного обсуждения проектов НПА изменен формат размещения подзаконных проектов НПА. В частности, для удобства населения на Портале будет размещаться основное содержание проекта НПА в доступной для ознакомления форме.",
                        "timestamp": "01/08 - 19:25",
                        "date": "01/08",
                        "time": "19:25",
                        "comment_id": "МИНИСТЕРСТВО ЦИФРОВОГО РАЗВИТИЯ_Здравствуйте! Согласно последним техническим_01/08 - 19:25"
                    }
                ],
                "total_comments": 4
            },
            {
                "id": "15559985",
                "title": "О внесении изменений и дополнений в приказ исполняющего обязанности Министра цифрового развития, инноваций и аэрокосмической промышленности Республики Казахстан от 31 января 2020 года № 39/НҚ «Об утверждении реестра государственных услуг»",
                "url": "https://legalacts.egov.kz/npa/view?id=15559985",
                "category": "Информационные технологии",
                "status": "На рассмотрении",
                "comments": [
                    {
                        "author": "ИВАНОВ ПЕТР",
                        "content": "Предлагаю внести изменения в пункт 3 статьи 5, где указано, что срок рассмотрения заявлений составляет 30 дней. Считаю, что этот срок можно сократить до 15 дней, так как современные технологии позволяют обрабатывать документы значительно быстрее.",
                        "timestamp": "05/08 - 10:30",
                        "date": "05/08",
                        "time": "10:30",
                        "comment_id": "ИВАНОВ ПЕТР_Предлагаю внести изменения в пункт 3 статьи 5_05/08 - 10:30"
                    },
                    {
                        "author": "ПЕТРОВА АННА",
                        "content": "Полностью поддерживаю проект. Внесенные изменения позволят упростить процедуру получения государственных услуг и сократить время ожидания для граждан.",
                        "timestamp": "04/08 - 16:45",
                        "date": "04/08",
                        "time": "16:45",
                        "comment_id": "ПЕТРОВА АННА_Полностью поддерживаю проект. Внесенные изменения_04/08 - 16:45"
                    }
                ],
                "total_comments": 2
            },
            {
                "id": "15559469",
                "title": "О проекте распоряжения Президента Республики Казахстан «О персональном составе Совета по развитию искусственного интеллекта»",
                "url": "https://legalacts.egov.kz/npa/view?id=15559469",
                "category": "Информационные технологии",
                "status": "На рассмотрении",
                "comments": [
                    {
                        "author": "СИДОРОВ АЛЕКСЕЙ",
                        "content": "Очень важный документ для развития ИИ в Казахстане. Предлагаю включить в состав Совета представителей ведущих IT-компаний и научных организаций для обеспечения баланса между государственными и частными интересами.",
                        "timestamp": "06/08 - 11:20",
                        "date": "06/08",
                        "time": "11:20",
                        "comment_id": "СИДОРОВ АЛЕКСЕЙ_Очень важный документ для развития ИИ в Казахстане_06/08 - 11:20"
                    },
                    {
                        "author": "КОЗЛОВА МАРИЯ",
                        "content": "Согласна с предложением. Также считаю необходимым добавить представителей академического сообщества, специализирующихся на этике ИИ и социальных аспектах внедрения новых технологий.",
                        "timestamp": "05/08 - 14:15",
                        "date": "05/08",
                        "time": "14:15",
                        "comment_id": "КОЗЛОВА МАРИЯ_Согласна с предложением. Также считаю необходимым_05/08 - 14:15"
                    },
                    {
                        "author": "МИНИСТЕРСТВО ЦИФРОВОГО РАЗВИТИЯ, ИННОВАЦИЙ И АЭРОКОСМИЧЕСКОЙ ПРОМЫШЛЕННОСТИ РК",
                        "content": "Благодарим за предложения. Все поступившие комментарии будут рассмотрены при формировании окончательного состава Совета. Представители IT-индустрии и научного сообщества обязательно будут включены в состав.",
                        "timestamp": "07/08 - 09:30",
                        "date": "07/08",
                        "time": "09:30",
                        "comment_id": "МИНИСТЕРСТВО ЦИФРОВОГО РАЗВИТИЯ_Благодарим за предложения. Все поступившие_07/08 - 09:30"
                    }
                ],
                "total_comments": 3
            }
        ] 