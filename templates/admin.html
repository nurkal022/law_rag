{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - RAG –°–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-cog me-2"></i>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
        </h2>
    </div>
</div>

<div class="row">
    <!-- System Status -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <h4 class="text-primary">{{ stats.documents_count }}</h4>
                        <small class="text-muted">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-info">{{ stats.chunks_count }}</h4>
                        <small class="text-muted">–ß–∞–Ω–∫–æ–≤</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-success">{{ stats.embedded_chunks }}</h4>
                        <small class="text-muted">–° embeddings</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <small>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:</small>
                        <small>{{ "%.1f"|format(stats.embedding_progress) }}%</small>
                    </div>
                    <div class="progress">
                        <div class="progress-bar 
                            {% if stats.embedding_progress >= 100 %}bg-success
                            {% elif stats.embedding_progress >= 50 %}bg-warning
                            {% else %}bg-danger{% endif %}" 
                            style="width: {{ stats.embedding_progress }}%">
                        </div>
                    </div>
                </div>
                
                {% if stats.embedding_progress < 100 %}
                <div class="alert alert-warning p-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>–°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</small>
                </div>
                {% else %}
                <div class="alert alert-success p-2">
                    <i class="fas fa-check-circle me-2"></i>
                    <small>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Document Processing -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-text me-2"></i>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞</h6>
                        <p class="text-muted small">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ embeddings
                        </p>
                        <button id="autoSetupBtn" class="btn btn-success">
                            <i class="fas fa-magic me-2"></i>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>–†—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞</h6>
                        <p class="text-muted small">
                            –ü–æ—à–∞–≥–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        </p>
                        <div class="d-grid gap-2">
                            <button id="processDocsBtn" class="btn btn-primary btn-sm">
                                <i class="fas fa-cogs me-2"></i>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
                            </button>
                            <button id="updateEmbeddingsBtn" class="btn btn-info btn-sm">
                                <i class="fas fa-sync me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å embeddings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Area -->
                <div id="progressArea" class="mt-4" style="display: none;">
                    <hr>
                    <h6>–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</h6>
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="progressLog" class="border rounded p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace; font-size: 0.85rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- System Management -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button id="clearHistoryBtn" class="btn btn-warning">
                        <i class="fas fa-trash me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤
                    </button>
                    <button id="refreshStatsBtn" class="btn btn-secondary">
                        <i class="fas fa-refresh me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    </button>
                    <a href="/" class="btn btn-success">
                        <i class="fas fa-comments me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ —á–∞—Ç—É
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- API Status -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plug me-2"></i>–°—Ç–∞—Ç—É—Å API
                </h5>
            </div>
            <div class="card-body">
                <div id="apiStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                        </div>
                        <p class="text-muted mt-2">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ API...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for confirmations -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" id="confirmBtn" class="btn btn-danger">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentAction = null;

    // Check API status on load
    checkApiStatus();

    function checkApiStatus() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('apiStatus');
                if (data.error) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger p-2">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>–û—à–∏–±–∫–∞:</strong> ${data.error}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success p-2">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ</strong>
                        </div>
                        <small class="text-muted">
                            –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${data.documents_count} | 
                            –ß–∞–Ω–∫–æ–≤: ${data.chunks_count} | 
                            –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${data.embedding_progress.toFixed(1)}%
                        </small>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('apiStatus').innerHTML = `
                    <div class="alert alert-danger p-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>–ù–µ—Ç —Å–≤—è–∑–∏ —Å API</strong>
                    </div>
                `;
            });
    }

    function showProgress() {
        document.getElementById('progressArea').style.display = 'block';
        document.getElementById('progressLog').innerHTML = '';
        document.getElementById('progressBar').style.width = '0%';
    }

    function addLogMessage(message, type = 'info') {
        const log = document.getElementById('progressLog');
        const timestamp = new Date().toLocaleTimeString();
        const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        
        log.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    // Auto-setup functionality
    document.getElementById('autoSetupBtn').addEventListener('click', function() {
        if (this.disabled) return;
        
        showProgress();
        addLogMessage('üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');
        
        this.disabled = true;
        this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–ù–∞—Å—Ç—Ä–æ–π–∫–∞...';
        
        fetch('/api/admin/auto_setup', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogMessage('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
                data.steps.forEach(step => {
                    const icon = step.status === 'completed' ? '‚úÖ' : 
                                step.status === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
                    const type = step.status === 'completed' ? 'success' : 
                                step.status === 'skipped' ? 'info' : 'error';
                    addLogMessage(`${icon} ${step.step}: ${step.message}`, type);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const stats = data.final_stats;
                addLogMessage(`üìä –ò—Ç–æ–≥–æ: ${stats.documents_count} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, ${stats.chunks_count} —á–∞–Ω–∫–æ–≤, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å ${stats.embedding_progress.toFixed(1)}%`, 'success');
                
                updateProgress(100);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    location.reload();
                }, 3000);
            } else {
                addLogMessage(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${data.error}`, 'error');
                
                if (data.steps) {
                    data.steps.forEach(step => {
                        addLogMessage(`${step.step}: ${step.message}`, 'error');
                    });
                }
                
                updateProgress(0);
            }
        })
        .catch(error => {
            addLogMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-magic me-2"></i>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞';
        });
    });

    // Process all documents
    document.getElementById('processDocsBtn').addEventListener('click', function() {
        if (this.disabled) return;
        
        showProgress();
        addLogMessage('–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...');
        
        this.disabled = true;
        this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–û–±—Ä–∞–±–æ—Ç–∫–∞...';
        
        fetch('/api/admin/process_documents', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogMessage(`–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.result.processed} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤`, 'success');
                addLogMessage(`–û—à–∏–±–æ–∫: ${data.result.failed}`, data.result.failed > 0 ? 'error' : 'info');
                addLogMessage(`–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${data.result.total}`, 'info');
                
                if (data.result.errors && data.result.errors.length > 0) {
                    data.result.errors.forEach(error => {
                        addLogMessage(error, 'error');
                    });
                }
                
                updateProgress(100);
                
                // Refresh page after delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                addLogMessage(`–û—à–∏–±–∫–∞: ${data.error}`, 'error');
                updateProgress(0);
            }
        })
        .catch(error => {
            addLogMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-cogs me-2"></i>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã';
        });
    });

    // Update embeddings
    document.getElementById('updateEmbeddingsBtn').addEventListener('click', function() {
        if (this.disabled) return;
        
        showProgress();
        addLogMessage('–û–±–Ω–æ–≤–ª—è–µ–º embeddings...');
        
        this.disabled = true;
        this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        fetch('/api/admin/update_embeddings', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLogMessage('Embeddings —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                updateProgress(100);
                
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                addLogMessage(`–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        })
        .catch(error => {
            addLogMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-sync me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å embeddings';
        });
    });

    // Clear history with confirmation
    document.getElementById('clearHistoryBtn').addEventListener('click', function() {
        currentAction = 'clearHistory';
        document.getElementById('confirmMessage').textContent = 
            '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
        
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    });

    // Confirm action
    document.getElementById('confirmBtn').addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
        modal.hide();
        
        if (currentAction === 'clearHistory') {
            clearChatHistory();
        }
    });

    function clearChatHistory() {
        const btn = document.getElementById('clearHistoryBtn');
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–û—á–∏—Å—Ç–∫–∞...';
        
        fetch('/api/admin/clear_history', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞');
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.error}`);
            }
        })
        .catch(error => {
            alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash me-2"></i>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤';
        });
    }

    // Refresh stats
    document.getElementById('refreshStatsBtn').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        setTimeout(() => {
            location.reload();
        }, 500);
    });
});
</script>
{% endblock %} 